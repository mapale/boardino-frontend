requirejs.config({baseUrl:"",paths:{vendor:"static/assets/vendor",jquery:"static/assets/vendor/jquery","jquery-ui":"static/assets/vendor/jquery-ui.min",bootstrap:"static/assets/vendor/bootstrap.min",backbone:"static/assets/vendor/backbone-min",underscore:"static/assets/vendor/underscore-min",json2:"static/assets/vendor/json2",paper:"static/assets/vendor/paper",io:"static/assets/vendor/socket.io.min"},shim:{"jquery-ui":{exports:"$",deps:["jquery"]},bootstrap:{exports:"$",deps:["jquery"]},underscore:{exports:"_"},backbone:{deps:["jquery","underscore","json2"],exports:"Backbone"},paper:{exports:"paper"},io:{exports:"io"}}}),define(["jquery","backbone","app"],function(a,b,c){function d(b){var c=null;if(document.cookie&&""!==document.cookie)for(var d=document.cookie.split(";"),e=0;e<d.length;e++){var f=a.trim(d[e]);if(f.substring(0,b.length+1)===b+"="){c=decodeURIComponent(f.substring(b.length+1));break}}return c}return b._sync=b.sync,b.sync=function(a,c,e){if("create"==a||"update"==a||"delete"==a){var f=d("csrftoken");e.beforeSend=function(a){a.setRequestHeader("X-CSRFToken",f)}}return b._sync(a,c,e)},c.initialize(),console.log("jQuery version: ",a.fn.jquery),a(function(){console.log("Backbone: ",b.VERSION)}),{}}),define("app",["jquery","app/views/board","app/views/canvas","app/boardconnection","app/boardmessagehandler","app/toolbar","app/utils","app/models/board","bootstrap"],function(a,b,c,d,e,f,g,h){var i=function(){function c(){var a=g.getBoardId();l=new h({id:a}),l.fetch();var c=new e;j=new d(a,c),k=new b({boardConnection:j}),c.setBoardView(k),k.render()}function i(){var b=new f;b.addTool(a("#eraser_tool").tool(b,{action:function(){a("#board").css("cursor","url(/static/images/eraser_disabled.ico),default"),k.selectEraserTool()}})),b.addTool(a("#postit_tool").tool(b,{action:function(){a("#board").css("cursor","url(/static/images/postit_disabled.ico),default"),k.selectPostitTool()}})),b.addTool(a("#selected_pencil_tool").tool(b,{enabledClass:"pencil_black_tool_enabled",disabledClass:"pencil_tool_disabled",action:function(){}})),b.addTool(a("#pencil_black_tool").tool(b,{action:function(){a("#board").css("cursor","url(/static/images/pencil_disabled.ico),default"),k.selectPencilTool("black"),a("#selected_pencil_tool").attr("class","pencil_black_tool_enabled")}})),b.addTool(a("#pencil_green_tool").tool(b,{action:function(){a("#board").css("cursor","url(/static/images/pencil_green_disabled.ico),default"),k.selectPencilTool("green"),a("#selected_pencil_tool").attr("class","pencil_green_tool_enabled")}})),b.addTool(a("#pencil_red_tool").tool(b,{action:function(){a("#board").css("cursor","url(/static/images/pencil_red_disabled.ico),default"),k.selectPencilTool("red"),a("#selected_pencil_tool").attr("class","pencil_red_tool_enabled")}})),b.addTool(a("#pencil_blue_tool").tool(b,{action:function(){a("#board").css("cursor","url(/static/images/pencil_blue_disabled.ico),default"),k.selectPencilTool("blue"),a("#selected_pencil_tool").attr("class","pencil_blue_tool_enabled")}})),b.addTool(a("#clear_lines_tool").tool(b,{action:function(){k.clearLines()},confirmable:!0,exclusive:!1})),b.addTool(a("#rectline_tool").tool(b,{action:function(){a("#board").css("cursor","url(/static/images/rectline_disabled.ico),default"),k.selectRectLineTool("FF000000")}}))}var j,k,l;a(document).ready(function(){c(),i();var b=a("#pencil_tool");b.mouseover(function(){a("#pencil_tool").width(200),a("#selected_pencil_tool").hide(),a("#pencil_black_tool").show(),a("#pencil_green_tool").show(),a("#pencil_red_tool").show(),a("#pencil_blue_tool").show()}),b.mouseout(function(){a("#pencil_tool").width(50),a("#selected_pencil_tool").show(),a("#pencil_black_tool").hide(),a("#pencil_green_tool").hide(),a("#pencil_red_tool").hide(),a("#pencil_blue_tool").hide()});var d=a("#menu");d.menu(),a("#menu_tool").mouseover(function(){d.show()}),d.mouseleave(function(){d.hide()});var e=a("#set-password-modal");a("#set-password").click(function(a){a.preventDefault(),e.modal()});var f=a("#set-password-btn");f.click(function(b){b.preventDefault(),a(this).button("loading");var c=a("#board-password"),d=a("#board-password2"),g=c.val(),h=d.val();g===h?(l.set("password",g),l.save({},{success:function(){e.modal("hide"),f.button("reset"),c.val(""),a("set-password-error").hide()}})):(a("#set-password-error").fadeIn(),f.button("reset"))}),a(window).bind("beforeunload",function(){j.disconnect()})})};return{initialize:i}}),define("app/boardconnection",["jquery","io"],function(a,b){"use strict";function c(c,d){this.ws=b.connect("http://"+window.ws_host);var e=this;this.ws.on("connect",function(){e.subscribe(c),e.ws.on("message",function(b){d.handle(a.parseJSON(b))})})}return c.prototype.disconnect=function(){this.ws.disconnect()},c.prototype.send=function(a,b){b.channel_id||(b.channel_id=this.board_id),this.ws.send(JSON.stringify({type:a,args:b}))},c.prototype.movePostit=function(a,b,c){this.send("move",{id:a,x:b,y:c})},c.prototype.resizePostit=function(a,b,c){this.send("resize",{id:a,w:b,h:c})},c.prototype.updatePostitText=function(a,b){this.send("update",{id:a,text:b})},c.prototype.changePostitColor=function(a,b,c){this.send("change_color",{id:a,color:b,back_color:c})},c.prototype.subscribe=function(a){this.board_id=a,this.send("register",{})},c.prototype.newPostit=function(a,b,c,d,e,f){this.send("new",{obj:"postit",id:a,x:b,y:c,w:d,h:e,text:f})},c.prototype.deletePostit=function(a){this.send("delete",{obj:"postit",id:a})},c.prototype.deleteLine=function(a){this.send("delete",{obj:"line",id:a})},c.prototype.startPath=function(a,b,c,d){this.send("startPath",{id:a,x:b,y:c,color:d})},c.prototype.addPathPoint=function(a,b,c){this.send("addPathPoint",{id:a,x:b,y:c})},c.prototype.finishPath=function(a){this.send("finishPath",{id:a})},c}),define("app/boardmessagehandler",["jquery"],function(a){var b=function(){var b;this.boardView=null;var c=this;this.handlers={startPath:function(a){c.boardView.startPath(a.id,a.x,a.y,a.color)},addPathPoint:function(a){c.boardView.addPathPoint(a.id,a.x,a.y)},finishPath:function(a){c.boardView.finishPath(a.id)},"new":function(a){"postit"===a.obj&&c.boardView.showPostit(a.id)},update:function(a){c.boardView.updatePostitText(a.id,a.text)},move:function(a){c.boardView.movePostit(a.id,a.x,a.y)},resize:function(a){c.boardView.resizePostit(a.id,a.w,a.h)},"delete":function(a){"postit"===a.obj?c.boardView.deletePostit(a.id):c.boardView.deleteLine(a.id)},change_color:function(a){c.boardView.changePostitColor(a.id,a.back_color)},info:function(c){b=c.users+1,a("#connected_users").text(b)},register:function(){b++,a("#connected_users").text(b),a("<div/>").addClass("user_connected").appendTo(a("#notifications")).text("1 user joined!").show("slow").hide(4e3,function(){a(this).remove()})},disconnect:function(){b--,a("#connected_users").text(b),a("<div/>").addClass("user_disconnected").appendTo(a("#notifications")).text("1 user left!").show("slow").hide(4e3,function(){a(this).remove()})}}};return b.prototype.handle=function(a){var b=a.type;this.handlers[b]&&this.handlers[b](a.args)},b.prototype.setBoardView=function(a){this.boardView=a},b}),define("app/collections/lines",["backbone","app/models/line","app/utils"],function(a,b,c){var d=c.getBoardId(),e=a.Collection.extend({model:b,url:"api/boards/"+d+"/lines/"});return e}),define("app/collections/postits",["backbone","app/models/postit","app/utils"],function(a,b,c){var d=c.getBoardId(),e=a.Collection.extend({model:b,url:"api/boards/"+d+"/postits/"});return e}),define("app/models/board",["backbone"],function(a){var b=a.Model.extend({urlRoot:"api/boards/"});return b}),define("app/models/line",["backbone","app/utils"],function(a,b){var c=b.getBoardId(),d=a.Model.extend({urlRoot:"api/boards/"+c+"/lines/",initialize:function(){}});return d}),define("app/models/postit",["backbone","app/utils"],function(a,b){var c=b.getBoardId(),d=a.Model.extend({urlRoot:"api/boards/"+c+"/postits/",initialize:function(){}});return d}),define("app/toolbar",["jquery"],function(){var a=function(){this.tools=[]};return a.prototype.addTool=function(a){this.tools.push(a)},function(a){a.fn.tool=function(b,c){var d=a.extend({element:this,enabledClass:this.attr("id")+"_enabled",disabledClass:this.attr("id")+"_disabled",exclusive:!0},c);return this.click(function(){d.exclusive&&a.each(b.tools,function(a,b){b.element.attr({"class":b.disabledClass})}),a(this).attr({"class":d.enabledClass}),d.confirmable?a("#dialog").dialog({buttons:{Confirm:function(){a(this).dialog("close"),d.action()},Cancel:function(){a(this).dialog("close")}}}):d.action()}),d}}(jQuery),a}),define("app/utils",[],function(){function a(){var a=window.location.pathname.replace(/^\/([^\/]*).*$/,"$1");return a?a:""}return{getBoardId:a}}),define("app/views/board",["jquery","backbone","app/views/postit","app/views/canvas","app/models/postit","app/collections/postits"],function(a,b,c,d,e,f){var g=b.View.extend({el:a("#board"),events:{"mousedown #board-canvas":"mousedown",mousemove:"mouseMove",mouseup:"mouseUp"},initialize:function(a){this.boardConnection=a.boardConnection,this.tool="postits",this.canvas=new d({boardConnection:this.boardConnection}),this.canvas.render(),this.postits=new f,this.postits.bind("add",this.addOne,this),this.postits.bind("reset",this.addAll,this),this.postits.bind("all",this.render,this),this.postits.fetch()},mousedown:function(a){if("drawing"===this.tool&&this.canvas.startLine(a.pageX,a.pageY,"free"),"rectDrawing"===this.tool&&this.canvas.startLine(a.pageX,a.pageY,"rect"),"eraser"===this.tool&&this.canvas.tryToErase(a.pageX,a.pageY),"postits"===this.tool){var b=new e({x:a.pageX,y:a.pageY,width:120,height:120,text:""});this.postits.add(b);var c=this;b.save(null,{success:function(a){c.boardConnection.newPostit(a.get("id"),b.get("x"),b.get("y"),b.get("width"),b.get("height"),b.get("text"))}}),b.trigger("focus")}return!1},mouseMove:function(a){("drawing"===this.tool||"rectDrawing"===this.tool)&&this.canvas.mouseMove(a)},mouseUp:function(a){("drawing"===this.tool||"rectDrawing"===this.tool)&&this.canvas.finishLine(a)},showPostit:function(a){var b=new e({id:a});b.fetch(),this.postits.add(b)},addAll:function(){this.postits.each(this.addOne,this)},addOne:function(b){var d=new c({model:b,boardConnection:this.boardConnection});a("#board").append(d.render().el)},movePostit:function(a,b,c){this.postits.get(a).set({x:b,y:c})},resizePostit:function(a,b,c){this.postits.get(a).set({width:b,height:c})},changePostitColor:function(a,b){this.postits.get(a).set("back_color",b)},deletePostit:function(a){this.postits.remove(a)},updatePostitText:function(a,b){this.postits.get(a).set("text",b)},startPath:function(a,b,c,d){this.canvas.startPath(a,b,c,d)},addPathPoint:function(a,b,c){this.canvas.addPathPoint(a,b,c)},finishPath:function(a){this.canvas.finishPath(a)},selectPostitTool:function(){this.tool="postits"},selectPencilTool:function(a){this.tool="drawing",this.canvas.setStrokeColor(a)},selectRectLineTool:function(){this.tool="rectDrawing",this.canvas.setStrokeColor("black")},selectEraserTool:function(){this.tool="eraser"},clearLines:function(){this.canvas.clearLines()},deleteLine:function(a){this.canvas.deleteLine(a)}});return g}),define("app/views/canvas",["jquery","backbone","underscore","paper","app/models/line","app/collections/lines"],function(a,b,c,d,e,f){var g=b.View.extend({el:a("#board-canvas"),lines:new f,initialize:function(a){this.boardConnection=a.boardConnection,this.strokeColor="black";var b=this;this.lines.fetch({success:function(a){c.each(a.models,function(a){a.get("path")&&(a.path=b.lineToPath(a),a.path.model=a)}),d.view.draw()}});var e=this.el;d.setup(e)},render:function(){d.view.draw()},startLine:function(a,b,c){var f=new e;f.set("color_l",this.strokeColor),f.type=c;var g=new d.Path;g.model=f,g.strokeColor=this.strokeColor;var h=new d.Point(a,b);g.add(h);var i=this;f.save({stroke_w:1},{success:function(c){i.line=c,i.line.path=g,i.lines.add(c),i.boardConnection.startPath(c.get("id"),a,b,c.get("color_l")),d.view.draw()}})},mouseMove:function(a){var b=this;setTimeout(function(){b.line&&1===a.which&&"free"===b.line.type&&(b.line.path.add(new d.Point(a.pageX,a.pageY)),b.boardConnection.addPathPoint(b.line.get("id"),a.pageX,a.pageY)),d.view.draw()},0)},finishLine:function(a){"rect"===this.line.type?(this.line.path.add(new d.Point(a.pageX,a.pageY)),this.boardConnection.addPathPoint(this.line.get("id"),a.pageX,a.pageY)):this.line.path.simplify(10),d.view.draw(),this.boardConnection.finishPath(this.line.get("id")),this.line.save({path:this.serialize(this.line.path)}),this.line=null},serialize:function(b){var c=[];return a.each(b.getSegments(),function(a,b){var d={point:{x:b.getPoint().x,y:b.getPoint().y},handleIn:{x:b.getHandleIn().x,y:b.getHandleIn().y},handleOut:{x:b.getHandleOut().x,y:b.getHandleOut().y}};c.push(d)}),JSON.stringify(c)},lineToPath:function(b){var c=new d.Path;return c.strokeColor=b.get("color_l"),a.each(a.parseJSON(b.get("path")),function(a,b){c.add(new d.Segment(b.point,b.handleIn,b._handleOut))}),c},startPath:function(a,b,c){var f=new e({id:a}),g=new d.Path;g.add(new d.Point(b,c)),f.path=g,f.path.model=f,f.fetch({success:function(a){g.strokeColor=a.get("color_l")}}),this.lines.add(f)},addPathPoint:function(a,b,c){this.lines.get(a).path.add(new d.Point(b,c)),d.view.draw()},finishPath:function(a){this.lines.get(a).path.simplify(10),d.view.draw()},setStrokeColor:function(a){this.strokeColor=a},clearLines:function(){var a=this;c.chain(this.lines.models).clone().each(function(b){b.path&&b.path.remove(),b.destroy(),a.boardConnection.deleteLine(b.get("id"))}),d.view.draw()},tryToErase:function(a,b){var c={segments:!0,stroke:!0,fill:!0,tolerance:5},e=d.project.hitTest(new d.Point(a,b),c);e&&(e.item.remove(),this.boardConnection.deleteLine(e.item.model.get("id")),e.item.model.destroy(),d.view.draw())},deleteLine:function(a){this.lines.get(a)&&(this.lines.get(a).path.remove(),d.view.draw())}});return g}),define("app/views/postit",["jquery-ui","backbone"],function(a,b){var c=b.View.extend({tagName:"div",events:{mouseover:"showToolbar",mouseout:"hideToolbar","click .postit_close_image":"deletePostit","mouseover .postit_color_image":"showColors","keyup .postit_input":"updateText"},initialize:function(b){this.boardConnection=b.boardConnection,this.model.bind("change",this.render,this),this.model.bind("destroy",this.remove,this),this.model.bind("remove",this.remove,this),this.model.bind("focus",this.focus,this);var c=this;this.$el.attr("id","postit"+this.model.id).addClass("postit").css("position","absolute").css("top",this.model.get("y")+"px").css("left",this.model.get("x")+"px").css("width",this.model.get("width")+"px").css("height",this.model.get("height")+"px").css("padding","22px 2px 2px 2px").css("background-color",this.model.get("back_color")).draggable({stack:".postit",cursor:"move",containment:"parent",drag:function(){var b=a(this).position();c.boardConnection.movePostit(c.model.get("id"),b.left,b.top)},stop:function(){var b=a(this).position();c.model.save({x:b.left,y:b.top})}}).resizable({resize:function(){var b=a(this).width(),d=a(this).height();c.boardConnection.resizePostit(c.model.get("id"),b,d)},stop:function(a,b){var d=b.size.width,e=b.size.height;c.model.save({width:d,height:e})}}),this.createPostitCloseElement().appendTo(this.$el),this.createPostitColorTool().appendTo(this.$el),this.createPostitTextArea().appendTo(this.$el),this.createChangePostitColorTool().appendTo(this.$el),this.input=this.$(".postit_input")},focus:function(){this.input.focus()},render:function(){return this.$el.css("top",this.model.get("y")+"px").css("left",this.model.get("x")+"px").css("width",this.model.get("width")+"px").css("height",this.model.get("height")+"px").css("background-color",this.model.get("back_color")),this.input.css("background-color",this.model.get("back_color")),this.input.val(this.model.get("text")),this},createPostitCloseElement:function(){return a("<img/>").addClass("postit_close_image").attr("src","/static/images/close.png")},deletePostit:function(){this.model.destroy(),this.boardConnection.deletePostit(this.model.get("id"))},createPostitTextArea:function(){var b=a("<textarea/>").addClass("postit_input").css("background-color",this.model.get("back_color"));return b.val(this.model.get("text")),b},updateText:function(){var a=this.input.val();this.model.save({text:a},{silent:!0}),this.boardConnection.updatePostitText(this.model.get("id"),a)},createPostitColorTool:function(){var b=a("<img/>").addClass("postit_color_image").attr("src","/static/images/colors.png");return b},showColors:function(){this.$el.find(".postit_color_tool").show()},createChangePostitColorTool:function(){var b=a("<div />").addClass("postit_color_tool");return b.mouseout(function(){b.hide()}),this.createColorSelectionElement("#FFFF33","left").appendTo(b),this.createColorSelectionElement("#FF69B4","right").appendTo(b),this.createColorSelectionElement("#ADFF2F","left").appendTo(b),this.createColorSelectionElement("gold","right").appendTo(b),b.hide()},createColorSelectionElement:function(b,c){var d=this;return a("<div class='postit_color'/>").css("background-color",b).css("float",c).click(function(){d.model.save({back_color:b}),d.boardConnection.changePostitColor(d.model.get("id"),b,b)})},showToolbar:function(){this.$el.find(".postit_close_image").show(),this.$el.find(".postit_color_image").show(),this.$el.css("padding-top","2px"),this.$el.css("padding-bottom","20px")},hideToolbar:function(){this.$el.find(".postit_close_image").hide(),this.$el.find(".postit_color_image").hide(),this.$el.css("padding-top","22px"),this.$el.css("padding-bottom","2px")}});return c});